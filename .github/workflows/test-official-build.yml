name: ğŸ§® Test Official Upsilon Build

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username for build (max 15 chars)'
        required: false
        default: 'PiStreamTest'

jobs:
  test-official-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Official Upsilon Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: ğŸ“¦ Install Build Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          gcc-arm-none-eabi \
          build-essential \
          imagemagick \
          libfreetype6-dev \
          libjpeg-dev \
          libpng-dev \
          pkg-config \
          python3 \
          python3-pip
        
        echo "âœ… Dependencies installed successfully"
        
    - name: ğŸ”§ Verify Upsilon Configuration
      run: |
        echo "ğŸ“‹ Build configuration:"
        cat build/config.mak
        echo ""
        echo "ğŸ“ Apps available:"
        ls -la apps/
        echo ""
        echo "ğŸ”§ libaxx configuration:"
        cat libaxx/Makefile
        
    - name: ğŸ—ï¸ Build Official Upsilon Firmware
      run: |
        USERNAME="${{ github.event.inputs.username || 'PiStreamTest' }}"
        echo "ğŸš€ Building Official Upsilon firmware"
        echo "ğŸ‘¤ Username: $USERNAME"
        
        echo "ğŸ§¹ Cleaning previous build..."
        make clean
        
        echo "ğŸš€ Starting build with verbose output..."
        set -e
        make OMEGA_USERNAME="$USERNAME" -j$(nproc) 2>&1 | tee build.log
        
        echo "ğŸ” Checking build results..."
        find output/ -name "*.bin" -o -name "*.elf" 2>/dev/null || echo "No firmware files found"
        
        # Check if build succeeded
        if [ -f "output/device/n0110/release/epsilon.bin" ]; then
          echo "âœ… Official firmware build successful!"
          FILESIZE=$(stat -c%s output/device/n0110/release/epsilon.bin)
          echo "ğŸ“¦ Firmware size: $FILESIZE bytes"
          ls -la output/device/n0110/release/epsilon.bin
        else
          echo "âŒ Official firmware build failed!"
          echo "ğŸ“‹ Build log (last 100 lines):"
          tail -100 build.log
          exit 1
        fi
        
    - name: ğŸ“¦ Build Binpack
      run: |
        USERNAME="${{ github.event.inputs.username || 'PiStreamTest' }}"
        echo "ğŸ“¦ Building binpack for WebDFU..."
        
        make OMEGA_USERNAME="$USERNAME" binpack -j$(nproc) 2>&1 | tee binpack.log
        
        # Check if binpack build succeeded
        if [ -f "output/device/n0110/release/binpack.bin" ]; then
          echo "âœ… Binpack build successful!"
          FILESIZE=$(stat -c%s output/device/n0110/release/binpack.bin)
          echo "ğŸ“¦ Binpack size: $FILESIZE bytes"
          ls -la output/device/n0110/release/binpack.bin
        else
          echo "âŒ Binpack build failed!"
          echo "ğŸ“‹ Binpack log (last 100 lines):"
          tail -100 binpack.log
          exit 1
        fi
        
    - name: ğŸ“ Upload Official Upsilon Firmware
      uses: actions/upload-artifact@v4
      with:
        name: official-upsilon-${{ github.event.inputs.username || 'PiStreamTest' }}-${{ github.run_number }}
        path: |
          output/device/n0110/release/epsilon.bin
          output/device/n0110/release/binpack.bin
          build.log
          binpack.log
        retention-days: 7
        
    - name: ğŸ‰ Official Build Summary
      run: |
        echo "ğŸŠ Official Upsilon Firmware Build Complete!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Generated Files:"
        ls -la output/device/n0110/release/*.bin
        echo ""
        echo "ğŸ“‹ File Sizes:"
        du -h output/device/n0110/release/*.bin
        echo ""
        echo "âœ… Official Upsilon apps included:"
        echo "  - calculation, graph, rpn, code, statistics"
        echo "  - probability, solver, atomic, sequence" 
        echo "  - regression, reader, settings, external"
        echo ""
        echo "ğŸ”— Next: Add Pi Stream app to this working base"
