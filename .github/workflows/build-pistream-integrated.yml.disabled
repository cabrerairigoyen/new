name: ğŸ§® Build Pi Stream Integrated

on:
  push:
    branches: [ upsilon-dev, main ]
    paths:
      - 'apps/pistream/**'
      - 'build/config.mak'
  workflow_dispatch:
    inputs:
      username:
        description: 'Username (max 15 chars)'
        required: false
        default: 'PiStreamV2'

jobs:
  build-pistream-integrated:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ“¦ Install Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          gcc-arm-none-eabi \
          build-essential \
          imagemagick \
          libfreetype6-dev \
          libjpeg-dev \
          libpng-dev \
          pkg-config \
          python3 \
          python3-pip

    - name: ğŸ“‹ Show Pi Stream Configuration
      run: |
        echo "=== BUILD CONFIGURATION ==="
        cat build/config.mak | grep EPSILON_APPS
        echo ""
        echo "=== PI STREAM APP FILES ==="
        ls -la apps/pistream/
        echo ""
        echo "=== READER REPLACEMENT ==="
        if grep -q "reader" build/config.mak; then
          echo "âŒ Reader still in config!"
        else
          echo "âœ… Reader successfully replaced by pistream"
        fi

    - name: ğŸ”§ Verify Pi Stream Implementation
      run: |
        echo "=== CHECKING PI STREAM UART GPIO ==="
        if grep -q "getRXNE" apps/pistream/pi_stream_controller.cpp; then
          echo "âœ… UART GPIO implementation found (getRXNE)"
        else
          echo "âŒ UART GPIO implementation missing"
          exit 1
        fi

        if grep -q "USART6" apps/pistream/pi_stream_controller.cpp; then
          echo "âœ… USART6 reference found"
        else
          echo "âŒ USART6 reference missing"
        fi

        if grep -q "Config::Port" apps/pistream/pi_stream_controller.cpp; then
          echo "âœ… Direct register access found"
        else
          echo "âŒ Direct register access missing"
        fi

    - name: ğŸ—ï¸ Build Upsilon with Pi Stream
      run: |
        USERNAME="${{ github.event.inputs.username || 'PiStreamV2' }}"
        echo "ğŸš€ Building Upsilon with Pi Stream v2 UART GPIO"
        echo "ğŸ‘¤ Username: $USERNAME"
        echo "ğŸ“± Target: n0110 (NumWorks)"
        echo "ğŸ”§ Apps: calculation, graph, rpn, code, statistics, probability, solver, atomic, sequence, regression, pistream, settings, external"

        make clean
        make OMEGA_USERNAME="$USERNAME" -j$(nproc) 2>&1 | tee build.log

        # Check build result
        if [ -f "output/device/n0110/release/epsilon.bin" ]; then
          echo "âœ… Pi Stream v2 build successful!"
          FILESIZE=$(stat -c%s output/device/n0110/release/epsilon.bin)
          echo "ğŸ“¦ Firmware size: $FILESIZE bytes"
          ls -la output/device/n0110/release/epsilon.bin
        else
          echo "âŒ Pi Stream v2 build failed!"
          echo "ğŸ“‹ Build log (last 100 lines):"
          tail -100 build.log
          exit 1
        fi

    - name: ğŸ“¦ Build Binpack for WebDFU
      run: |
        USERNAME="${{ github.event.inputs.username || 'PiStreamV2' }}"
        make OMEGA_USERNAME="$USERNAME" binpack -j$(nproc)

        if [ -f "output/device/n0110/release/binpack.bin" ]; then
          echo "âœ… Binpack created successfully!"
          FILESIZE=$(stat -c%s output/device/n0110/release/binpack.bin)
          echo "ğŸ“¦ Binpack size: $FILESIZE bytes"
          ls -la output/device/n0110/release/binpack.bin
        else
          echo "âŒ Binpack creation failed!"
          exit 1
        fi

    - name: ğŸ“ Upload Pi Stream v2 Firmware
      uses: actions/upload-artifact@v4
      with:
        name: pistream-v2-integrated-${{ github.run_number }}
        path: |
          output/device/n0110/release/epsilon.bin
          output/device/n0110/release/binpack.bin
          build.log
        retention-days: 7

    - name: ğŸ‰ Pi Stream v2 Integration Complete
      run: |
        echo "ğŸŠ Pi Stream v2 Successfully Integrated!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Generated Files:"
        ls -la output/device/n0110/release/*.bin
        echo ""
        echo "ğŸ“‹ File Sizes:"
        du -h output/device/n0110/release/*.bin
        echo ""
        echo "ğŸ”§ Pi Stream Features:"
        echo "  âœ… UART GPIO communication (USART6, C6/C7 pins)"
        echo "  âœ… Non-blocking register access (getRXNE polling)"
        echo "  âœ… LaTeX formula rendering ($$...$$ delimiters)"
        echo "  âœ… Real-time data display"
        echo "  âœ… 50ms polling interval"
        echo "  âœ… 1024 char buffer"
        echo "  âœ… n0110 compatibility"
        echo ""
        echo "ğŸ“± App Integration:"
        echo "  âœ… Reader app replaced by Pi Stream"
        echo "  âœ… Same menu position and icon"
        echo "  âœ… Full Upsilon integration"
        echo ""
        echo "ğŸ”— Next Steps:"
        echo "  1. Download binpack.bin"
        echo "  2. Flash via WebDFU: https://ti-planet.github.io/webdfu_numworks/n0110/"
        echo "  3. Connect Raspberry Pi GPIO:"
        echo "     - Pi GPIO 8 â†’ NumWorks C7 (RX)"
        echo "     - Pi GPIO 10 â†’ NumWorks C6 (TX)"
        echo "     - Pi GPIO 6 â†’ NumWorks GND"
        echo "  4. Test UART communication!"
        echo ""
        echo "ğŸŠ Â¡Pi Stream v2 listo para usar en NumWorks n0110!"
