name: 🧮 Build Clean Upsilon

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      username:
        description: 'Username (max 15 chars)'
        required: false
        default: 'TestClean'

jobs:
  build-clean-upsilon:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: 📦 Install Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          gcc-arm-none-eabi \
          build-essential \
          imagemagick \
          libfreetype6-dev \
          libjpeg-dev \
          libpng-dev \
          pkg-config \
          python3 \
          python3-pip
        
    - name: 📋 Show Configuration
      run: |
        echo "📋 Default Upsilon configuration:"
        cat build/config.mak
        echo ""
        echo "📁 Available apps:"
        ls -1 apps/ | grep -E '^[a-z]' | head -10
        
    - name: 🏗️ Build Upsilon Firmware
      run: |
        USERNAME="${{ github.event.inputs.username || 'TestClean' }}"
        echo "🚀 Building clean Upsilon firmware"
        echo "👤 Username: $USERNAME"
        
        make clean
        make OMEGA_USERNAME="$USERNAME" -j$(nproc) 2>&1 | tee build.log
        
        # Check build result
        if [ -f "output/device/n0110/release/epsilon.bin" ]; then
          echo "✅ Build successful!"
          ls -la output/device/n0110/release/epsilon.bin
        else
          echo "❌ Build failed!"
          tail -50 build.log
          exit 1
        fi
        
    - name: 📦 Build Binpack
      run: |
        USERNAME="${{ github.event.inputs.username || 'TestClean' }}"
        make OMEGA_USERNAME="$USERNAME" binpack -j$(nproc)
        
        if [ -f "output/device/n0110/release/binpack.bin" ]; then
          echo "✅ Binpack created!"
          ls -la output/device/n0110/release/binpack.bin
        fi
        
    - name: 📁 Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: clean-upsilon-${{ github.run_number }}
        path: |
          output/device/n0110/release/epsilon.bin
          output/device/n0110/release/binpack.bin
          build.log
        if-no-files-found: ignore
        retention-days: 7
